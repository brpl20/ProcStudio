#!/bin/sh

# Check for Ruby files in the backend
if git diff --cached --name-only | grep -qE "\.(rb|rake)$"; then
  echo "Running RuboCop on staged Ruby files..."
  git diff --cached --name-only --diff-filter=ACM | grep -E "\.(rb|rake)$" | xargs bundle exec rubocop -A --except Layout/LineLength,Metrics/MethodLength,Metrics/AbcSize,Metrics/CyclomaticComplexity,Metrics/PerceivedComplexity
  
  if [ $? -ne 0 ]; then
    echo "RuboCop found critical issues. Please fix them before committing."
    exit 1
  fi
  
  # Re-add auto-fixed files
  git diff --cached --name-only --diff-filter=ACM | grep -E "\.(rb|rake)$" | xargs git add
fi

# Check for frontend files
if git diff --cached --name-only | grep -q "^frontend/"; then
  echo "Running frontend pre-commit checks..."
  cd frontend
  
  # Run ESLint on staged files
  npx lint-staged
  LINT_EXIT_CODE=$?
  
  if [ $LINT_EXIT_CODE -ne 0 ]; then
    echo "‚ùå Frontend linting failed. Please fix the errors before committing."
    exit 1
  fi
fi

exit 0